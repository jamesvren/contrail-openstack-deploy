---
################################
# Copy/Modify configuration file
################################
- name: Get volumes mapping directory
  set_fact:
    plugin_dir: "{% if nova_config_root is defined %}{{ nova_config_root }}/opt/plugin{% else %}opt/plugin{% endif %}"

- debug: var=plugin_dir

- name: Create opt/plugin directory
  file:
    path: "{{ plugin_dir }}"
    state: directory

- name: Create distro directory
  file:
    path: "{{ nova_config_root }}/usr/lib/python2.7/site-packages/"
    state: directory

- debug:
    msg: "Nova configuration file in {{ nova_config_directory }}"

- name: Copying over nova patch
  template:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
  with_items:
    - { src: "nova_rootwrap.conf", dest: "{{ nova_config_directory }}/nova_rootwrap.conf" }
    - { src: "contrail-plugin.pth.j2", dest: "{{ nova_config_root }}/usr/lib/python2.7/site-packages/contrail-plugin.pth" }
  notify:
    - Restart nova-compute container

#################################
# Initialize Nova Plugin
#################################
- name: Running Nova opencontrail bootstrap container
  docker_container:
    name: bootstrap_nova_compute_opencontrail_plugin
    image: "{{ nova_compute_opencontrail_init_image_full }}"
    volumes:
      - "{{ plugin_dir }}:/opt/plugin/"
  notify:
    - Restart nova-compute container

- name: Copy vroute_port_control to /usr/bin
  become: yes
  command: mv {{ plugin_dir }}/bin {{ nova_config_root }}/usr/
  notify:
    - Restart nova-compute container

#- name: Copy Nova plugin to Nova compute container
#  command: docker cp {{ item.src }} {{ nova_compute_container_name }}:{{ item.dest }}
#  become: yes
#  when:
#    - containered_stack is defined
#  with_items:
#    - { src: "/opt/plugin", dest: "/opt/" }
#    - { src: "{{ nova_config_directory }}/contrail-plugin.pth", dest: "/usr/lib/python2.7/site-packages/" }
#  notify:
#    - Restart nova-compute container

- name: Clean Nova init container
  docker_container:
    name: bootstrap_nova_compute_opencontrail_plugin
    state: absent

- name: Clean Nova init images
  docker_image:
    state: absent
    name: "{{ nova_compute_opencontrail_init_image_full }}"
