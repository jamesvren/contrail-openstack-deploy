---
################################
# Copy/Modify configuration file
################################
- name: Get volumes mapping directory
  set_fact:
    plugin_dir: "{% if neutron_config_root is defined %}{{ neutron_config_root }}/opt/plugin{% else %}opt/plugin{% endif %}"

- debug: var=plugin_dir

- name: Create opt/plugin directory
  file:
    path: "{{ plugin_dir }}"
    state: directory

- name: Create distro directory
  file:
    path: "{{ neutron_config_root }}/usr/lib/python2.7/site-packages"
    state: directory

- debug:
    msg: "Neutron configuration file in {{ neutron_config_directory }}"

- name: create contrail plugin directory
  become: yes
  file:
    path: "{{ neutron_config_directory }}/plugins/opencontrail"
    state: directory

- name: Copying over neutron plugin
  template:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
  with_items:
    - { src: "ContrailPlugin.ini.j2", dest: "{{ neutron_config_directory }}/plugins/opencontrail/ContrailPlugin.ini" }
    - { src: "neutron_rootwrap.conf", dest: "{{ neutron_config_directory }}/rootwrap.conf" }
    #- { src: "api-paste.ini.j2", dest: "{{ neutron_config_directory }}/api-paste.ini" }
    - { src: "contrail-plugin.pth.j2", dest: "{{ neutron_config_root }}usr/lib/python2.7/site-packages/contrail-plugin.pth" }
    #- { src: "neutron-server.json.j2", dest: "{{ neutron_config_directory }}/config.json" } #only open it for openstack kolla. Do NOT use it for RHOP13.
  notify:
    - "Restart neutron-server container"

- name: point to contrail plugin
  file:
    src: /etc/neutron/plugins/opencontrail/ContrailPlugin.ini
    dest: "{{ neutron_config_directory }}/plugin.ini"
    state: link
    force: yes

- name: set interface driver
  replace:
    path: "{{ neutron_config_directory }}/neutron.conf"
    regexp: '^interface_driver.*'
    replace: 'interface_driver ='
  notify:
    - "Restart neutron-server container"

- name: set contrail core plugin
  replace: 
    path: "{{ neutron_config_directory }}/neutron.conf"
    regexp: '^core_plugin.*'
    replace: 'core_plugin = neutron_plugin_contrail.plugins.opencontrail.contrail_plugin.NeutronPluginContrailCoreV2'
  notify:
    - "Restart neutron-server container"

- name: set service plugins
  replace:
    path: "{{ neutron_config_directory }}/neutron.conf"
    regexp: '^service_plugins.*'
    replace: 'service_plugins = neutron_plugin_contrail.plugins.opencontrail.loadbalancer.v2.plugin.LoadBalancerPluginV2'
  notify:
    - "Restart neutron-server container"

- name: set api extension path
  lineinfile:
    dest: "{{ neutron_config_directory }}/neutron.conf"
    regexp: '.*api_extensions_path.*'
    insertafter: '^service_plugins'
    line: 'api_extensions_path = /opt/plugin/site-packages/neutron_plugin_contrail/extensions:/opt/plugin/site-packages/neutron_lbaas/extensions'
  notify:
    - "Restart neutron-server container"

- name: Create quotas section 
  lineinfile:
    dest: "{{ neutron_config_directory }}/neutron.conf"
    regexp: '^#\[quotas\]'
    line: '[quotas]'

- name: set quotas network value
  lineinfile:
    dest: "{{ neutron_config_directory }}/neutron.conf"
    insertafter: '^\[quotas\]'
    regexp: '^quota_network.*'
    line: 'quota_network = -1'
  notify:
    - "Restart neutron-server container"

- name: set quotas subnet value
  lineinfile:
    dest: "{{ neutron_config_directory }}/neutron.conf"
    insertafter: '^\[quotas\]'
    regexp: '^quota_subnet.*'
    line: 'quota_subnet = -1'
  notify:
    - "Restart neutron-server container"

- name: set quotas port value
  lineinfile:
    path: "{{ neutron_config_directory }}/neutron.conf"
    insertafter: '^\[quotas\]'
    regexp: '^quota_port.*'
    line: 'quota_port = -1'
  notify:
    - "Restart neutron-server container"

- name: set quotas driver value
  lineinfile:
    path: "{{ neutron_config_directory }}/neutron.conf"
    insertafter: '^\[quotas\]'
    regexp: '^quota_driver.*'
    line: 'quota_driver = neutron_plugin_contrail.plugins.opencontrail.quota.driver.QuotaDriver'
  notify:
    - "Restart neutron-server container"

################################
# Init Contrail Plugin
################################

- name: Running opencontrail init container for neutron server
  docker_container:
    name: bootstrap_neutron_opencontrail_plugin
    image: "{{ neutron_opencontrail_init_image_full }}"
    volumes: "{{ plugin_dir }}:/opt/plugin"
  notify:
    - "Restart neutron-server container"

- name: Clean neutron init container
  docker_container:
    name: bootstrap_neutron_opencontrail_plugin
    state: absent

- name: Clean neutron init images
  docker_image:
    state: absent
    name: "{{ neutron_opencontrail_init_image_full }}"
  
#- name: Copy plugin distro to neutron server container
#  become: yes
#  command: docker cp /opt/plugin {{ neutron_container_name }}:/opt/
#  when:
#    - containered_stack is defined
#
#- name: Clean temporary plugin directory
#  file:
#    path: /opt/plugin
#    state: absent
#  when:
#    - containered_stack is defined
#
#- name: Copy plugin to neutron server container
#  become: yes
#  command: docker cp {{ neutron_config_directory }}/{{ item.src }} {{ neutron_container_name }}:{{ item.dest }}
#  when:
#    - containered_stack is defined
#  with_items:
#    - { src: "plugins", dest: "/etc/neutron/" }
#    - { src: "rootwrap.conf", dest: "/etc/neutron/" }
#    - { src: "plugin.ini", dest: "/etc/neutron/" }
#    - { src: "contrail-plugin.pth", dest: "/usr/lib/python2.7/site-packages/" }
#  notify:
#    - "Restart neutron-server container"
